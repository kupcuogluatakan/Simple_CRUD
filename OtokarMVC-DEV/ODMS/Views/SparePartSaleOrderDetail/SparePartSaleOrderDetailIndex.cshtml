@using ODMSCommon.Resources
@using ODMSModel.SparePartSaleOrderDetail

@model SparePartSaleOrderDetailListModel
@{
    ViewBag.Title = @MessageResource.SparePartSaleOrderDetail_PageTitle_Index;
}
@Html.AntiForgeryToken()<br />
<style>
    .k-widget.k-tooltip {
        background-color: white;
        color: #090909;
    }

    .tooltip-content {
        background-color: white;
        text-align: left;
        padding: 10px;
    }

        .tooltip-content .bold {
            padding-right: 12px;
        }

    .color-box-wrapper {
        display: inline-block;
        margin: 0 5px;
        text-align: center;
    }

    .color-box {
        border-radius: 15px;
        content: "";
        display: inline-block;
        height: 15px;
        width: 15px;
    }
</style>
<div id="PopupWindow" style="background-color: #EDF1F4 !important" class="hide"></div>
<div id="modelWindowDiv">
    @(Html.Kendo().Window()
          .Name("modelWindow2")
          .Title("SparePartSaleOrderDetail")
          .Draggable()
          .Resizable()

          .Width(1250)
          .Height(700)
          .Scrollable(false)
          .Visible(false)
          .Modal(true)
          .Iframe(true)
          .Events(ev => ev.Close(@"function(e){
                ReloadPage();
            }"))
    )
</div>

<script>

    function ReloadPage() {
        var masterGrid = $('#grid').data('kendoGrid');
        masterGrid.dataSource.read();

        var grid = $('#grid2').data('kendoGrid');
        grid.dataSource.page(1);

        parent.ShowTabs('@Model.SoNumber', false);
    }

    function OpenCreatePopup() {
        $('#modelWindow2').html('');

        var frameTitle = '@MessageResource.SparePartSaleOrderDetail_PageTitle_Create';
        var link = "@Url.Action("SparePartSaleOrderDetailCreate", "SparePartSaleOrderDetail", new {soNumber = "p1"})";
        link = link.replace("p1", '@Model.SoNumber');

        ShowPopup(frameTitle, link, 1500, 700);
    }

    $(document).ready(function() {
        if ('@ViewBag.OpenCreatePopup' == 'True')
            OpenCreatePopup();
    });

    $(function() {
        RegisterEventHandlers();
        AddColumnHeaderTooltip();
    });
    function AddColumnHeaderTooltip() {
        $('th').each(function () {
            var title = $(this).attr("data-title"); //$(this).attr('href', 'http://www.somesitename.com/filter' + this.href);
            $(this).attr("title", title);
        });
    }
    function RegisterEventHandlers() {
        $("body").delegate("#showSearch2", "click", function() {
            var isVisible = Boolean($(this).hasClass("searchVisible"));

            if (!isVisible) {
                $(this).html('@MessageResource.Global_Display_Hide_Search_Criteria');
                $(this).addClass("searchVisible");
                $("#searchDiv2").show("slow");
            } else {
                $(this).html('@MessageResource.Global_Display_Search_Criteria');
                $(this).removeClass("searchVisible");
                $("#searchDiv2").hide("slow");
            }
        });

        $("body").delegate("#btnSearch2", "click", function() {
            var grid = $('#grid2').data('kendoGrid');
            grid.dataSource.page(1);

        });

        $("body").delegate("#btnCreate2", "click", function() {
            $('#modelWindow2').html('');

            var frameTitle = $(this).attr("frameTitle");
            var link = "@Url.Action("SparePartSaleOrderDetailCreate", "SparePartSaleOrderDetail", new {soNumber = "p1"})";
            link = link.replace("p1", '@Model.SoNumber');

            ShowPopup(frameTitle, link, 1500, 700);
        });
    }

    function ShowPopup(frameTitle, link, width, height) {
        $("#modelWindow2_wnd_title").html(frameTitle);

        var windowWidget = $("#modelWindow2").data("kendoWindow");
        var closeOrigin = windowWidget.close;
        windowWidget.refresh({
            url: link
        }).center();

        windowWidget.wrapper.css({
            width: width,
            height: height
        });
        windowWidget.center();
        windowWidget.open();

    }

    function ViewSparePartSaleOrderDetail(obj, SparePartSaleOrderDetailId) {
        $('#modelWindow2').html('');

        var frameTitle = $(obj).attr("frameTitle");

        var link = "@Url.Action("SparePartSaleOrderDetailDetails", "SparePartSaleOrderDetail", new {SparePartSaleOrderDetailId = "p1", soNumber = "p2"})";
        link = link.replace("p1", SparePartSaleOrderDetailId);
        link = link.replace("p2", '@Model.SoNumber');

        ShowPopup(frameTitle, link, 910, 450);
    }

    function UpdateSparePartSaleOrderDetail(obj, SparePartSaleOrderDetailId) {
        $('#modelWindow2').html('');

        var frameTitle = $(obj).attr("frameTitle");
        var link = "@Url.Action("SparePartSaleOrderDetailUpdate", "SparePartSaleOrderDetail", new {SparePartSaleOrderDetailId = "p1", soNumber = "p2"})";
        link = link.replace("p1", SparePartSaleOrderDetailId);
        link = link.replace("p2", '@Model.SoNumber');

        ShowPopup(frameTitle, link, 910, 450);
    }

    function DeleteSparePartSaleOrderDetail(SparePartSaleOrderDetailId) {
        var token = $('input[name="__RequestVerificationToken"]').val();

        DeleteConfirm(function() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("SparePartSaleOrderDetailDelete", "SparePartSaleOrderDetail")",
                data: { SparePartSaleOrderDetailId: SparePartSaleOrderDetailId, SoNumber: '@Model.SoNumber', "__RequestVerificationToken": token },
                traditional: true,
                success: function(result) {
                    if (result.Status == 0)
                        SetErrorMessage(result.Message);
                    else {
                        var grid = $('#grid2').data('kendoGrid');
                        grid.dataSource.read();
                        SetSuccessMessage(result.Message);
                    }
                },
                dataType: "json"
            });
        });
    }

    function DisplayPlannedQuantity(soNumber, plannedQuantity) {
        if (plannedQuantity > 0) {
            return "<center><a class='listSaleOrderDetails modalClick' frameTitle='" + '@CommonUtility.GetResourceValue("SparePartSaleOrder_PageTitle_SaleOrderDetails")' + "' id='" + soNumber + "'" +
                " href='~/SparePartSaleOrder/SparePartSaleOrderListSaleOrderDetails/" + soNumber
                + "'>" + soNumber + "</a></center>";
        } else {
            return "<center><a>" + soNumber + "</a></center>";
        }
    }

    function CancelSparePartSaleOrderDetail(SparePartSaleOrderDetailId) {
        var token = $('input[name="__RequestVerificationToken"]').val();

        CustomConfirm(function() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("SparePartSaleOrderDetailCancel", "SparePartSaleOrderDetail")",
                data: { SparePartSaleOrderDetailId: SparePartSaleOrderDetailId, SoNumber: '@Model.SoNumber', "__RequestVerificationToken": token },
                traditional: true,
                success: function(result) {
                    if (result.Status == 0)
                        SetErrorMessage(result.Message);
                    else {
                        var grid = $('#grid2').data('kendoGrid');
                        grid.dataSource.read();
                        SetSuccessMessage(result.Message);
                    }
                },
                dataType: "json"
            });
        }, "@MessageResource.SparePartSale_Display_Cancel", "@MessageResource.SparePartSale_Display_CancelConfirm", "@MessageResource.Global_Display_Yes", "@MessageResource.Global_Display_No");

    }

    function SelectAll() {
        var checked = $('#SelectAll').prop('checked');
        var grid = $('#grid2').data("kendoGrid");
        var list = grid.dataSource.data();
        for (var i = 0; i < list.length; i++) {
            list[i].IsSelected = checked;
        }
        $(".cbSelect", "#grid2").prop("checked", checked);
    }

    function selectChange(obj) {
        var grid = $('#grid2').data("kendoGrid");
        var row = $(obj).closest("tr");
        var item = grid.dataItem(row);
        item.IsSelected = $(obj).prop("checked");
    }

    function onChange(e) {

        debugger;
        if ((parseFloat(e.model.ListPrice).toFixed(2) < parseFloat(e.values.ConfirmPrice).toFixed(2))) {
            if (e.values.AppliedDiscountRatio != e.model.AppliedDiscountRatio) {
                console.log("3")
                e.preventDefault();
                e.model.set("AppliedDiscountRatio", e.values.AppliedDiscountRatio);
                var confirmPrice = e.model.ListPrice - (e.model.ListPrice * parseFloat(e.values.AppliedDiscountRatio.toString().replace(".",",")).toFixed(2) / 100);
                e.model.set("ConfirmPrice", parseFloat(confirmPrice).toFixed(2).toString().replace(".",","));
                e.preventDefault();
                return;
            }else
            {
            e.preventDefault();
            console.log("1")
            e.model.set("AppliedDiscountRatio", 0);
            e.model.set("ConfirmPrice",  e.model.OrderPrice);
            e.preventDefault();
            return;
}
        } else if (e.values.ConfirmPrice != e.model.ConfirmPrice && (e.values.AppliedDiscountRatio == null )) {
                console.log("2")
            var discountRatio = parseFloat((1 - (e.values.ConfirmPrice / e.model.ListPrice)) * 100).toFixed(2);
  
            e.model.set("AppliedDiscountRatio", discountRatio.toString().replace(".",","));
            e.model.set("ConfirmPrice",  e.values.ConfirmPrice);
            e.preventDefault();
            return;
        }
           
    }

    function Search() {
        return {
            SoNumber: '@Model.SoNumber'
        };
    }

    function onEdit(e) {
        var data = e.model;
        var statusId = data.StatusId;
        if (data.IsSelected == false || (statusId != 0 && statusId != 2 && statusId != 3)) {
            this.closeCell();
        }
        e.preventDefault();
    }

    function UpdateDetails(obj) {
        var items = [];

        $(".btnUpdateDetails").addClass("disabled");
        var grid = $('#grid2').data("kendoGrid");
        var list = grid.dataSource.data();

        for (var i = 0; i < list.length; i++) {
            if (list[i].IsSelected == true) {
                items.push({ SparePartSaleOrderDetailId: list[i].SparePartSaleOrderDetailId, ConfirmPrice: list[i].ConfirmPrice, AppliedDiscountRatio: list[i].AppliedDiscountRatio, SoNumber: @Model.SoNumber });
            }
        }
        $.ajax('@Url.Action("UpdateDetails", "SparePartSaleOrderDetail")',
        {
            traditional: true,
            cache: false,
            success: function(json) {
                if (json.errorNo == 1)
                    SetErrorMessage(json.errorMessage);
                else {
                    $(".btnUpdateDetails").removeClass("disabled");
                    //var grid = $('#grid2').data('kendoGrid');
                    //grid.dataSource.read();
                    refreshGridAndselectRow(true);
                    ShowTabs(@Model.SoNumber, false);
                    SetSuccessMessage("@MessageResource.Global_Display_Success");
                }
            },
            error: function(xhr) {
                SetErrorMessage(xhr.responseText);
            },
            data: JSON.stringify(items),
            dataType: "json",
            method: "post"
        });
    }

    function onDataBound() {
        $("a.kendotooltip").each(function (i, e) {
            toolTipIt(e);
        });
    }
    function toolTipIt(it) {
        var partId = $(it).data("partid");
        $(it).kendoTooltip({
            content: {
                url: "@Url.Action("GetChangedPartInfo","SparePart")?partId=" + partId
            },
            width: 250,
            height: 100,
            position: "top",
        });
    }
    function openpopup(partCode) {
        $('#PopupWindow').kwnd('@Url.Action("SparePartAssemblePopup","SparePartAssemble")?partCode=' + partCode, '@Html.Raw(MessageResource.Global_Display_ChangedParts)',
                   {
                       iframe: false,
                       width: 1200,
                       height: 450,
                       onClose: function () {
                           $("#PopupWindow").empty();
                       }
                   });
        $('#PopupWindow').removeClass("hide");
        OpenWindow($('#PopupWindow'));
    }
   
</script>
@if (Model.PODetailCount == 0
                 && (Model.MasterStatusId == (int)CommonValues.SparePartSaleOrderStatus.NewRecord
                     || Model.MasterStatusId == (int)CommonValues.SparePartSaleOrderStatus.NotApprovedOrder
                     || Model.MasterStatusId == (int)CommonValues.SparePartSaleOrderStatus.NotApprovedProposal))
{
    @ODMSHelpers.LinkButton("btnCreate2", MessageResource.Global_Display_New, "Create", "modalClick createNew", MessageResource.SparePartSaleOrderDetail_PageTitle_Create, CommonValues.PermissionCodes.SparePartSaleOrderDetail.SparePartSaleOrderDetailCreate)
}
@Html.ExportExcelButton(new ExcelExportDto("SparePartSaleOrderDetail", "ListSparePartSaleOrderDetails", "Search", "sdfsdf").Build<SparePartSaleOrderDetailListModel, object>(
                c => c.SparePartCode, c => c.SparePartName, c => c.PoNumber, c => c.OrderQuantity, c => c.PlannedQuantity, c => c.ShippedQuantity
                                        , c => c.ListPrice, c => c.OrderPrice, c => c.ConfirmPrice, c => c.CurrencyCode, c => c.ListDiscountRatio, c => c.AppliedDiscountRatio
                                            , c => c.StatusName))

<div class="checkbox"><label>@Html.CheckBox("SelectAll", new { onClick = "SelectAll();" }) @MessageResource.Global_Display_SelectAll</label> </div>
<div class="kendoGridDiv" id="grd2">
    @(Html.Kendo().Grid<SparePartSaleOrderDetailListModel>()
          .Name("grid2")
          .Columns(columns =>
          {
              columns.Bound(p => p.IsSelected).ClientTemplate("#if((StatusId != 0 || StatusId != 2 || StatusId != 3)&& StatusId != 9){#<input type='checkbox' onchange='selectChange(this);' class='cbSelect' name='IsSelected' />#}#").Title(CommonUtility.GetResourceValue("Global_Display_Select")).Width(50).Sortable(false);

              columns.Bound(d => d.SparePartSaleOrderDetailId).ClientTemplate("<center><a href='javascript:void(0);' frameTitle='"
                                                                              + MessageResource.SparePartSaleOrderDetail_PageTitle_Details + "' " +
                                                                              "onclick='ViewSparePartSaleOrderDetail(this,#=SparePartSaleOrderDetailId#);'>" +
                                                                              "<img class='iconLink' src='" + Url.Content("~/Images/view.png") +
                                                                              "'/></a></center>").Title(MessageResource.Global_Display_View).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.SparePartSaleOrderDetail.SparePartSaleOrderDetailDetails)).Width(40);
              columns.Bound(d => d.SparePartSaleOrderDetailId).ClientTemplate("#if((PurchaseOrderDetailSeqNo == null || PurchaseOrderDetailSeqNo == '')  && StatusId == 0 && (MasterStatusId == 0 || MasterStatusId == 2 || MasterStatusId == 3)){#" +
                                                                              "<center><a href='javascript:void(0);' frameTitle='" + MessageResource.SparePartSaleOrderDetail_PageTitle_Update + "' " +
                                                                              "onclick='UpdateSparePartSaleOrderDetail(this, #=SparePartSaleOrderDetailId#);'>" +
                                                                              "<img class='iconLink' src='" + Url.Content("~/Images/edit.png") +
                                                                              "'/></a></center>#}#").Title(MessageResource.Global_Display_Update).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.SparePartSaleOrderDetail.SparePartSaleOrderDetailUpdate)).Width(40);
              columns.Bound(d => d.SparePartSaleOrderDetailId).ClientTemplate("#if((PurchaseOrderDetailSeqNo == null || PurchaseOrderDetailSeqNo == '')  && StatusId == 0 && (MasterStatusId == 1 || MasterStatusId == 2 || MasterStatusId == 3)){#" +
                                                                              "<center><a href='javascript:void(0);' frameTitle='" + MessageResource.SparePartSaleOrderDetail_PageTitle_Delete + "' " +
                                                                              "onclick='DeleteSparePartSaleOrderDetail(#=SparePartSaleOrderDetailId#);'>" +
                                                                              "<img class='iconLink' src='" + Url.Content("~/Images/delete.png") +
                                                                              "'/></a></center>#}#").Title(MessageResource.Global_Display_Delete).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.SparePartSaleOrderDetail.SparePartSaleOrderDetailDelete)).Width(40);

                columns.Bound(d => d.SparePartSaleOrderDetailId).ClientTemplate("#if((StatusId == 0 ) && MasterStatusId != 5 && MasterStatusId != 9){#" +
                                                                              "<center><a href='javascript:void(0);' frameTitle='" + MessageResource.SparePartSaleOrderDetail_PageTitle_Cancel + "' " +
                                                                              "onclick='CancelSparePartSaleOrderDetail(#=SparePartSaleOrderDetailId#);'>" +
                                                                              "<img class='iconLink' src='" + Url.Content("~/Images/passive.png") +
                                                                              "'/></a></center>#}#").Title(MessageResource.Global_Display_Cancel).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.SparePartSaleOrderDetail.SparePartSaleOrderDetailDelete)).Width(40);

              columns.Bound(d => d.SparePartCode).ClientTemplate(
                  "#if (ChangedPartId!= null && ChangedPartId!=SparePartId){#" +
                  "#=SparePartCode# <a class='k-link kendotooltip' data-partid='#=ChangedPartId#' onclick='openpopup(\"#=SparePartCode#\");'> <i class='glyphicon glyphicon-info-sign'></i></a>" +
                  "#} else {# #=SparePartCode# #}# "

                  ).Width(100).Sortable(true);
              columns.Bound(d => d.SparePartName).Width(170).Sortable(true);
              columns.Bound(d => d.PoNumber).Width(100).Sortable(true);
              columns.Bound(d => d.OrderQuantity).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(p => p.PlannedQuantity).ClientTemplate("#=DisplayPlannedQuantity(SoNumber, PlannedQuantity)#").Title(MessageResource.SparePartSaleOrder_PageTitle_SaleOrderDetails).Width(30).Sortable(true);

              columns.Bound(d => d.ShippedQuantity).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.ListPrice).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.OrderPrice).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.ConfirmPrice).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.CurrencyCode).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.ListDiscountRatio).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.AppliedDiscountRatio).HtmlAttributes(new { style = "text-align:right" }).Width(50).Sortable(true);
              columns.Bound(d => d.StatusName).Width(150).Sortable(true);
          })
          .Sortable()

          .Events(e => e.Edit("onEdit").DataBound("onDataBound"))
          .Events(e => e.Save("onChange"))
          .Editable(editable => editable.Mode(GridEditMode.InCell))
          .DataSource(dataSource => dataSource
              .Ajax()
              .PageSize(10)
              .ServerOperation(true)
                      .Read(read => read.Action("ListSparePartSaleOrderDetails", "SparePartSaleOrderDetail").Data("Search"))
              .Model(model =>
              {
                  model.Id(p => p.SparePartSaleOrderDetailId);
                  model.Field(p => p.SparePartCode).Editable(false);
                  model.Field(p => p.SparePartName).Editable(false);
                  model.Field(p => p.PoNumber).Editable(false);
                  model.Field(p => p.OrderQuantity).Editable(false);
                  model.Field(p => p.PlannedQuantity).Editable(false);
                  model.Field(p => p.ShippedQuantity).Editable(false);
                  model.Field(p => p.ListPrice).Editable(false);
                  model.Field(p => p.OrderPrice).Editable(false);
                  model.Field(p => p.ConfirmPrice).Editable(true);
                  model.Field(p => p.CurrencyCode).Editable(false);
                  model.Field(p => p.ListDiscountRatio).Editable(false);
                  model.Field(p => p.AppliedDiscountRatio).Editable(true);
                  model.Field(p => p.StatusName).Editable(false);
              })
          )
    )
</div>
<div class="btn-group" style="height: 40px;">
    <button class="btn btn-info btnUpdateDetails" onclick=" UpdateDetails(this) ">
        <i class="fa fa-check"></i> &nbsp;
        @MessageResource.Global_Display_Save
    </button>
</div>