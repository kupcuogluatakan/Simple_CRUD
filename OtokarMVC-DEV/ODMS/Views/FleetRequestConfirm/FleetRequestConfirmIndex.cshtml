@using ODMSCommon.Resources
@using ODMSModel.FleetRequestConfirm

@model FleetRequestConfirmListModel
@{
    ViewBag.Title = @MessageResource.FleetRequestConfirm_PageTitle_Index;
}
@Html.AntiForgeryToken()
<div id="showSearch">@MessageResource.Global_Display_Search_Criteria</div>
<div id="searchDiv">
    <div id="searchFields">
        <div class="labelDiv">@Html.LabelFor(b => b.StatusName)</div>
        <div class="shortTxtDiv">
            @Html.Kendo().ComboBoxFor(c => c.StatusId).BindTo(ViewBag.StatusList as List<SelectListItem>).DataValueField("Value").DataTextField("Text").Placeholder(CommonUtility.GetResourceValue("Global_Display_Choose"))
        </div>
    </div>
</div>

@ODMSHelpers.LinkButton("btnSearch", MessageResource.Global_Display_Search, "", "", "", CommonValues.PermissionCodes.FleetRequestConfirm.FleetRequestConfirmIndex)


<div id="modelWindowDiv">
    @(Html.Kendo().Window()
        .Name("modelWindow")
        .Title("FleetRequestConfirm")
        .Draggable()
        .Resizable()
        .Width(410)
        .Height(400)
        .Scrollable(false)
        .Visible(false)
        .Modal(true)
        .Iframe(true)
        .Events(ev => ev.Close(@"function(e){
            var grid = $('#grid').data('kendoGrid');
            grid.dataSource.page(1);
            $('#divDetails').hide();
            }"))
    )
</div>

<script src="~/Scripts/jquery.maskedinput.js"></script>

<div class="kendoGridDiv" id="grd">
    @(Html.Kendo().Grid<FleetRequestConfirmListModel>()
          .Name("grid")
          .Columns(columns =>
          {
              columns.Bound(p => p.FleetRequestId).ClientTemplate("<center><a class='loadTab' onclick='loadTabs(\"#=FleetRequestId#\")' id='#=FleetRequestId#'><img class=iconLink src='"
                  + Url.Content("~/Images/tabs.png") + "'/></a></center>").Title(CommonUtility.GetResourceValue("Global_Display_Details")).Width(80).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.FleetRequestConfirm.FleetRequestConfirmIndex));
              columns.Bound(b => b.FleetRequestId).ClientTemplate("#if(StatusId==" + (int)CommonValues.FleetRequestStatus.FleetRequestWaitingForApproval
                  + "){#<center><a href='javascript:void(0);' frameTitle='" + MessageResource.FleetRequest_PageTitle_Delete + "' onclick='FleetRequestConfirmDetails(this,#=FleetRequestId#,#=" + (int)CommonValues.FleetRequestStatus.FleetRequestRejected + "#);'><img class='iconLink' style=\"width:20px; height:20px;\" src='" + Url.Content("~/Images/remove.png") + "'/></a></center>#}#").Title(MessageResource.Global_Display_Reject).Width(95).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.FleetRequestConfirm.FleetRequestConfirmCreate));
              columns.Bound(b => b.FleetRequestId).ClientTemplate("#if(StatusId==" + (int)CommonValues.FleetRequestStatus.FleetRequestWaitingForApproval
                  + "){#<center><a href='javascript:void(0);' frameTitle='" + MessageResource.FleetRequest_PageTitle_Delete + "' onclick='FleetRequestConfirmDetails(this,#=FleetRequestId#,#=" + (int)CommonValues.FleetRequestStatus.FleetRequestApproved + "#);'><img class='iconLink' style=\"width:20px; height:20px;\" src='" + Url.Content("~/Images/choose.ico") + "'/></a></center>#}#").Title(MessageResource.Fleet_Display_ConfirmRequest).Width(110).Sortable(false).Visible(ODMSHelpers.UserHasPermission(CommonValues.PermissionCodes.FleetRequestConfirm.FleetRequestConfirmCreate));
              columns.Bound(b => b.DealerName).Width(400).Sortable(true);
              columns.Bound(b => b.Description).Width(150).Sortable(true);
              columns.Bound(b => b.StatusName).Width(150).Sortable(true);
              columns.Bound(b => b.RejectDescription).Width(150).Sortable(false);
              columns.Bound(b => b.CreateDate).Width(120).Sortable(true).Format("{0:dd/MM/yyyy}");
          })
          .Pageable()
          .Sortable()
          .Scrollable()

          .DataSource(dataSource => dataSource
                                        .Ajax()
                                        .PageSize(10)
                                        .ServerOperation(true)
                                        .Read(read => read.Action("ListFleetRequestConfirm", "FleetRequestConfirm", Model).Data("Search"))
                                        .Model(model => model.Field(b => b.FleetRequestId).DefaultValue(-1)))
    )

</div>

<br />


<div id="divDetails">
    @(Html.Kendo().TabStrip()
          .Name("FleetVehiclDemandDetails")
          .Items(tabstrip => tabstrip.Add().Text(MessageResource.FleetRequestApprove_PageTitle_Index).LoadContentFrom(Url.Action("FleetRequestVehicleApproveIndex", "FleetRequestVehicleApprove")).Selected(true))
    )

</div>

<div id="rejectPanel" style="display:none;">
    <div style="display:none;" class="alert alert-danger">
        <span class="rejectMessage">Red nedeni giriniz!</span>
        <button type="button" class="close" onclick="$(this).parent().hide();">&times;</button>
    </div>
    <div>
        <div class='labelDiv'><label for='RejectDescription'>Red Nedeni</label></div>
        <div class='shortTxtDiv'><textarea class="rejectDescription" id='RejectDescription' rows='7' style='width:100% !important;'></textarea></div>
        <div class='clearDiv'>&nbsp;</div>
        @ODMSHelpers.LinkButton("btnReject", ODMSCommon.Resources.MessageResource.FleetRequestConfirm_Display_Reject, "", "btnReject", "", CommonValues.PermissionCodes.Fleet.FleetUpdate)
    </div>
</div>
<div>
    @(Html.Kendo().Window().Name("RejectDesModal")
          .Modal(true).Width(500).Height(240)
          .Visible(false)
          .HtmlAttributes(new { style = "background-color:#EDF1F4 !important" })
          .Events(evt => evt.Close("function(e){ $('#RejectDesModal').html(''); }"))
          .Title(@MessageResource.FleetRequestConfirm_Display_RejectConfirm)

    )
</div>


@section Scripts
{
    <script>

        function loadTabs(IdFleetReq) {

            if (IdFleetReq != '') {
                var tabStrip = $('#FleetVehiclDemandDetails').kendoTabStrip().data("kendoTabStrip");

                var partTab = tabStrip.contentElements[0];
                $.ajax({
                    type: "GET",
                    url: "@Url.Action("FleetRequestVehicleApproveIndex", "FleetRequestVehicleApprove")",
                    data: { id: IdFleetReq },
                    contentType: 'application/json; charset=utf-8',
                    success: function (result) {
                        $(partTab).html(result);
                    },
                    error: function (request, status, err) {
                        alert(status);
                        alert(err);
                    },
                    dataType: "html"
                });
                $('#divDetails').show();
            }
            else {
                $('#divDetails').hide();
            }

        }

        $(function () {
            $('#divDetails').hide();
            RegisterEventHandlers();
        });

        function RegisterEventHandlers() {

            $("body").delegate("#showSearch", "click", function (e) {
                var IsVisible = Boolean($(this).hasClass("searchVisible"));

                if (!IsVisible) {
                    $(this).html('@MessageResource.Global_Display_Hide_Search_Criteria');
                    $(this).addClass("searchVisible");
                    $("#searchDiv").show("slow");
                } else {
                    $(this).html('@MessageResource.Global_Display_Search_Criteria');
                    $(this).removeClass("searchVisible");
                    $("#searchDiv").hide("slow");
                }
            });


            $("body").delegate("#btnSearch", "click", function () {
                var grid = $('#grid').data('kendoGrid');
                grid.dataSource.page(1);
                $('#divDetails').hide();
            });

            $("body").delegate(".modalClick", "click", function (e) {
                $('#modelWindow').html('');
                e.preventDefault();

                var link;
                var clickedId = $(this).attr("id");
                var frameTitle = $(this).attr("frameTitle");

                if ($(this).hasClass("details") == true) {
                    link = "@Url.Action("FleetRequestDetails", "FleetRequest", new {fleetRequestId = -1})";
                    link = link.replace("-1", clickedId);
                }

                $("#modelWindow_wnd_title").html(frameTitle);

                var windowWidget = $("#modelWindow").data("kendoWindow");
                var closeOrigin = windowWidget.close;

                windowWidget.refresh({
                    url: link
                }).center();
                windowWidget.center();
                windowWidget.open();

            });
        }

        function Search() {
            return {
                StatusId: $("#StatusId").val()
            };
        }

        function ConfirmReject(frId, statusId, rejectDesc) {
            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                type: "POST",
                url: "@Url.Action("FleetRequestConfirmDetails","FleetRequestConfirm")",
                data: { fleetrequestId: frId, status: statusId, rejectDesc: rejectDesc, "__RequestVerificationToken": token },
                traditional: true,
                success: function (result) {
                    var windowWidget = $("#RejectDesModal").data("kendoWindow");
                    windowWidget.close();

                    if (result.Status == 0)
                        SetErrorMessage(result.Message);
                    else {
                        var grid = $('#grid').data('kendoGrid');
                        grid.dataSource.read();
                        SetSuccessMessage(result.Message);
                        $('#divDetails').hide();
                    }
                },
                dataType: "json"
            });
        }

        function Reject(frId, statusId) {
            var rejectDesc = $(".rejectDescription:last").val().trim();
            $(".rejectMessage").parent().hide();
            if (rejectDesc == "") {
                $(".rejectMessage").text("Red nedeni giriniz!");
                $(".rejectMessage").parent().show();
                return;
            }

            ConfirmReject(frId, statusId, rejectDesc);
        }

        function FleetRequestConfirmDetails(obj, frId, statusId) {

            if (statusId == -1) // rejected
            {
                var windowWidget = $("#RejectDesModal").data("kendoWindow");
                windowWidget.content($("#rejectPanel").html()).center().open();
                $(".btnReject").removeAttr("onclick");
                $(".btnReject").attr("onclick", "Reject(" + frId + "," + statusId + ")");
            }
            else {
                ConfirmReject(frId, statusId,null);
            }
        }

    </script>
}
