@{
    Layout = "~/Views/Shared/Popup_Layout.cshtml";
}
@using System.Linq
@using ODMSCommon.Resources
@model ODMSModel.WorkOrderCard.WorkOrderCampaignModel
<style>
    a:focus {
        outline: none;
        outline-offset: -2px;
    }

    #campaign-info {
        padding: 5px;
        margin-top: 6px;
        background-color: #ffffff;
        border: 1px solid #dddddd;
        border-radius: 4px;
    }

    #popupContentWrapper {
        height: 450px !important;
    }

    #popupContent {
        width: 97% !important;
    }

    body {
        overflow: hidden;
    }
</style>
@{
    var redText = MessageResource.Campaign_Display_Red;
 }
  

<div class="panel panel-success">
    <div class="panel-heading">
        <h5><strong>@MessageResource.WorkOrderCard_Display_AvailableCampaignList</strong></h5>
    </div>
    <div class="panel-body">
        <div id="warning-wrap" class="alert alert-warning" style=" margin-left:6px;display:none;">
            <a class="close" onclick="$('.alert').fadeOut();">&times;</a>
            <strong>
            </strong>
        </div>

        @if (Model.Campaigns.Any(c => c.IsMust == false))
        {
            <button class="btn btn-primary" onclick="OpenDenyWindow()">
                @MessageResource.WorkOrderCard_Display_CampaignDeny
            </button>

            <button class="btn btn-primary" onclick="OpenDenyDealerWindow()">
                @MessageResource.WorkOrderCard_Display__DealerCampaignDeny
            </button>

            if (Model.Campaigns.Any(c => !String.IsNullOrEmpty(c.Denied_Campaign_Codes)) || Model.Campaigns.Any(c => !String.IsNullOrEmpty(c.Denied_Campaign_Service_Codes)))
            {
                <a id="cancelRejection" href="javascript:void(0);" class="btn btn-danger" onclick="CancelCampaignRejections();">İptal Et</a>
            }


        }

        <hr />

        <div class="warn"></div>

        <div style="height: 300px; overflow-y: auto; ">
            <div id="campaign-list">
                <table class="table table-striped table-bordered" style=" margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th> <a id="selectCampAll" href="javascript:void(0);" onclick="toggleCampSelection(this);" toggled="0">@MessageResource.Global_Display_Select</a></th>
                            <th>@MessageResource.Global_Display_Add</th>
                            <th>@MessageResource.Campaign_Display_CampaignCode</th>
                            <th>@MessageResource.Campaign_Display_CampaignName</th>
                            <th>@MessageResource.Campaign_Display_Is_Must</th>
                            <th>@MessageResource.WorkOrderCard_Display_HasStock</th>
                            <th>@MessageResource.Campaign_Display_RedStatusCustomer</th>
                            <th>@MessageResource.Campaign_Display_RedStatusService</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Campaigns.Any())
                        {
                            foreach (var item in Model.Campaigns)
                            {
                                int redType1 = 0, redType2 = 0;


                                if (@item.Denied_Campaign_Codes.Contains(@item.CampaignCode))
                                {
                                    redType1 = 1; //Müşteri Reddi
                                }

                                if (@item.Denied_Campaign_Service_Codes.Contains(@item.CampaignCode))
                                {
                                    redType2 = 1; //Service Reddi
                                }


                                <tr ccode="@item.CampaignCode" ismust="@item.IsMust" hasstock="@item.HasStock" redtype1="@redType1" redType2="@redType2">
                                    <td>
                                        <a class="k-link" onclick="GetCampaignDetails('@item.CampaignCode',this)">
                                            <img class='iconLink' src="@Url.Content("~/Images/select.png")" />
                                        </a>
                                    </td>
                                    <td>

                                        <a class="k-link campDetail" onclick="AddCampaignToWorkOrder(@Model.WorkOrderId, '@item.CampaignCode', this);">
                                            <img class='iconLink' src="@Url.Content("~/Images/add.png")" />
                                        </a>
                                        @*GetCampaignDetails('@item.CampaignCode', this);*@
                                    </td>

                                    <td>@item.CampaignCode</td>
                                    <td>@item.CanpaignName</td>
                                    <td>
                                        @if (item.IsMust)
                                        {
                                            <strong style="color: #5cb85c"> <i class="glyphicon glyphicon-ok"></i></strong>
                                        }
                                        else
                                        {
                                            <strong style="color: #d9534f"> <i class="glyphicon glyphicon-remove"></i></strong>
                                        }

                                    </td>
                                    <td>
                                        @if (item.HasStock)
                                        {
                                            <strong style="color:#5cb85c"> <i class="glyphicon glyphicon-ok"></i></strong>
                                        }
                                        else
                                        {
                                            <strong style="color: #d9534f"> <i class="glyphicon glyphicon-remove"></i></strong>
                                        }

                                    </td>
                                    <td class="customerRed">
                                        @if (redType1 == 1)
                                        {
                                            @Html.Raw(redText);
                                        }

                                    </td>
                                    <td class="serviceRed">
                                        @if (redType2 == 1)
                                        {
                                            @Html.Raw(redText);
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">@MessageResource.WorkOrderCard_Display_NoCampaignAvailable</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="clearfix">

            </div>
            <div id="campaign-info" style="height: 250px; overflow-y: auto">
                <div class="k-loading k-loading-image hide"></div>
                <div class="navbar-text"><strong>@MessageResource.WorkOrderCard_Display_CampaignDetails</strong> </div>
                <div class="clearfix"></div>
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#labour" data-toggle="tab">@MessageResource.LabourDuration_Display_Labour</a></li>
                    <li><a href="#part" data-toggle="tab">@MessageResource.WorkOrderCard_Display_Part</a></li>
                    <li><a href="#document" data-toggle="tab">@MessageResource.CampaignDocument_Display_DocName</a></li>
                </ul>
                <div id="tabWrap" class="tab-content" style="background-color: white; padding:10px;border-right: 1px solid #dddddd;border-left: 1px solid #dddddd;border-bottom: 1px solid #dddddd">

                    <div class="tab-pane active" id="labour">

                    </div>
                    <div class="tab-pane" id="part">

                    </div>
                    <div class="tab-pane" id="document">

                    </div>
                </div>
            </div>
        </div>




    </div>
</div>
@(Html.Kendo().Window()
                      .Name("CampaignDenyWindow")
                      .Modal(true).Width(600).Height(340)
                      .Events(evt => evt.Close("function(e){$('#CampaignDenyWindow').html(''); $('.k-loading').addClass('hide'); /*console.log('sad')*/}"))
                      .Visible(false)
                      .Title(string.Format("{0} [{1}]", MessageResource.WorkOrderCard_PageTitle_Index, MessageResource.WorkOrderCard_Display_CampaignDeny)))
@(Html.Kendo().Window()
                      .Name("CampaignDenyDealerWindow")
                      .Modal(true).Width(600).Height(340)
                      .Events(evt => evt.Close("function(e){$('#CampaignDenyDealerWindow').html(''); $('.k-loading').addClass('hide'); /*console.log('sad')*/}"))
                      .Visible(false)
                      .Title(string.Format("{0} [{1}]", MessageResource.WorkOrderCard_PageTitle_Index, MessageResource.WorkOrderCard_Display__DealerCampaignDeny)))



<script type="text/javascript">
    var isLabourLoaded, isPartLoaded, isDocumentLoaded;
    var selectedCamps = [];
    $(document).ready(function () {

        if ('@ViewBag.selectedCamps' != null) {
            selectedCamps = ('@ViewBag.selectedCamps').split(',');
        }

        var trList = $("#campaign-list table tbody tr");
        trList.each(function () {
            var ccode = $(this).attr("ccode");
            if (selectedCamps.indexOf(ccode) > -1) {
                $(this).addClass("danger");
            }
        });

        if (selectedCamps.length == trList.length) {
            $("#selectCampAll").attr("toggled","1");
        }
        

    });


    function toggleCampSelection(elem) {

        var campToggled = $(elem).attr("toggled");

        var trList = $("#campaign-list table tbody tr");

        if (campToggled == "1") {
            $(elem).attr("toggled", "0");
            selectedCamps = [];
            trList.removeClass("danger");
            
        }
        else {

            trList.each(function () {

                var $trElem = $(this);

                if (!$trElem.hasClass("danger")) {
                    
                    if (!$trElem.attr("ismust")) {

                        $trElem.addClass("danger");

                        var ccode = $trElem.attr("ccode");
                        selectedCamps.push('' + ccode);
                    }

                   
                }

                $(elem).attr("toggled", "1");


            });
        }

    }

    function stockExistControl() {

        var hstockCount = 0;
        $("#campaign-list table tbody tr").each(function () {

            if ($(this).attr("hasstock")) {

                if (!$(this).hasClass("danger")) {
                    hstockCount++;
                }
            }
        });

        return hstockCount > 0;
    }

    function CampaignSelectionControl() {
        var IsSelected = 0;
        $("#campaign-list table tbody tr").each(function () {      
            if ($(this).hasClass("danger")) {
                IsSelected++;
            }        
        });

        return IsSelected > 0;

    }

    function GetCampaignDetails(campaignCode, obj) {
        var $obj = $(obj);
        $("tr.danger", $obj.parents("table:first")).removeClass("info");

        warn.removeClass("alert alert-danger alert-success").text("");

        var parentTr = $obj.closest("tr");

        if (parentTr.hasClass("danger")) {
            parentTr.removeClass("danger");

            var index = selectedCamps.indexOf(''+campaignCode);
            if (index > -1) {
                selectedCamps.splice(index, 1);
            }
        }
        else {

            if (!parentTr.attr("ismust")) {
                parentTr.addClass("danger");
                selectedCamps.push('' + campaignCode);
            }
            else {

                ////Bu if koşulu kritik kampanyanın tek açıldığı pencerede red işlemi yapılmadığı için seçtiğinde uyarı çıkmaması için konuldu.
                var urlCampCode = '@Request.QueryString["campaignCode"]';
                if (urlCampCode=="" || urlCampCode =='undefined') {
                     warn.addClass("alert alert-danger").html('@MessageResource.WorkOrderCard_Display_CriticalCampaingsCannotDeclined');
                }
                
            }

        }


        $('.k-loading').removeClass("hide");
        GetLabourHtml(campaignCode);
        GetPartHtml(campaignCode);
        GetDocumentHtml(campaignCode);


    }

    function GetLabourHtml(campaignCode) {
        isLabourLoaded = false;

        var request = $.ajax({
            url: '@Url.Action("GetCampaignDetail", "WorkOrderCard")',
            type: "POST",
            data: { campaignCode: campaignCode, type: "LABOUR" ,id:@Model.WorkOrderId},
            dataType: "html"
        });
        request.success(function (html) {
            isLabourLoaded = true;
            $('#labour').html(html);
            HideLoading();
        });
    }

    function GetPartHtml(campaignCode) {
        isPartLoaded = false;
        var request = $.ajax({
            url: '@Url.Action("GetCampaignDetail", "WorkOrderCard")',
            type: "POST",
            data: { campaignCode: campaignCode, type: "PART" ,id:@Model.WorkOrderId},
            dataType: "html"
        });
        request.success(function(html) {
            isPartLoaded = true;
            $('#part').html(html);
            HideLoading();
        });

    }

    function GetDocumentHtml(campaignCode) {
        isDocumentLoaded = false;
        var request = $.ajax({
            url: '@Url.Action("GetCampaignDetail", "WorkOrderCard")',
            type: "POST",
            data: { campaignCode: campaignCode, type: "DOCUMENT" ,id:@Model.WorkOrderId},
            dataType: "html"
        });
        request.success(function (html) {
            isDocumentLoaded = true;
            $('#document').html(html);
            HideLoading();
        });
    }

    function HideLoading() {
        if(isLabourLoaded==true && isPartLoaded==true && isDocumentLoaded==true)
            $('.k-loading').addClass("hide");
    }

    function AddCampaignToWorkOrder(workOrderId, campaignCode, obj) {

        mvc.build("@Url.Action("AddCampaign", "WorkOrderCard")", "", "", {
            WorkOrderId: workOrderId,
            'Campaigns[0].CampaignCode':campaignCode
        }, false, "json");
        mvc.post(null, function(json) {
            if (json.Result == false) {
                $("#warning-wrap").removeClass("alert-success").removeClass("alert-warning").addClass("alert-danger");
                $("#warning-wrap  strong").html(json.Message);
            } else {
                $("#warning-wrap").removeClass("alert-warning").removeClass("alert-danger").addClass("alert-success");
                $("#warning-wrap  strong").html(json.Message);
                $(obj).parents("tr:first").remove();

                RemoveFromDeniedCampaignList(workOrderId,campaignCode);

            }
            $("#warning-wrap").fadeIn();
        }, null);

    }

    // kampanyayı eklemek isterse ve kampanya seçili halde ise o listeden kaldır ki red notu eklemeye çalıştığında o kampanyayı eklemesin.
    function RemoveFromDeniedCampaignList(workOrderId,ccode) {
        
        var index = selectedCamps.indexOf('' + ccode);
        if (index > -1) {
            selectedCamps.splice(index, 1);

             $.ajax({
                        url: '@Url.Action("UpdateDeniedCampaigns", "WorkOrderCard")',
                        type: "POST",
                        data: {
                            id: workOrderId,
                            deniedCamps: ccode //deniedCamps olduğuna bakmayın sadece bir kampanya kodu olacak.
                        },
                        dataType: "JSON"
                    });
        }
    }

    function CancelCampaignRejections()
    {
        if (confirm('Red işlemlerinin iptalini onaylıyor musunuz?'))
        {
            warn.removeClass("alert alert-danger alert-success").text("");

        var request = $.ajax({
                url: '@Url.Action("CancelCampaignRejections", "WorkOrderCard")',
                type: "POST",
                data: {
                    id: @Model.WorkOrderId
                },
                dataType: "JSON"
            });

        request.success(function (json) {
            if (json.Result == false) {
                
                warn.addClass("alert alert-danger");

            } else {
                //warn.addClass("alert alert-success");

                var trList = $("#campaign-list table tbody tr");
                trList.each(function () {

                    var currentTr = $(this);

                    //currentTr.removeClass("danger");
                    //currentTr.find(".customerRed").html('');
                    //currentTr.find(".serviceRed").html('');
                    //$("#cancelRejection").remove();
                    window.location.reload();
                });

            }

            //warn.html(json.Message);

        });
        }

    }


    var warn = $(".warn");
    function OpenDenyWindow(campaignCode) {

        warn.removeClass("alert alert-danger alert-success").text("");

        if (stockExistControl()) {
            warn.html('@MessageResource.WorkOrderCard_Display_CampaignMustBeSelected').addClass("alert alert-danger");
        }
        else {
            $('#CampaignDenyWindow').html('');
        var windowWidget = $("#CampaignDenyWindow").data("kendoWindow");
        windowWidget.refresh({
            url: "@Url.Action("UpdateCampaignDenyReason")/" + @Model.WorkOrderId,
                data: {
                    deniedCamps: selectedCamps.length > 1 ? selectedCamps.join(",") : selectedCamps.join("")
                     }
                }).center();

            windowWidget.open();
        }
        
    }
    function OpenDenyDealerWindow(campaignCode) {

       warn.removeClass("alert alert-danger alert-success").text("");

        if (CampaignSelectionControl() > 0)
        {
             $('#CampaignDenyDealerWindow').html('');
             var windowWidget = $("#CampaignDenyDealerWindow").data("kendoWindow");
             windowWidget.refresh({
                 url: "@Url.Action("UpdateCampaignDenyDealerReason")/" + @Model.WorkOrderId,
                 data: {
                     deniedCamps: selectedCamps.length > 1 ? selectedCamps.join(",") : selectedCamps.join("")
                 }
             }).center();
            
             windowWidget.open();
        }
        else {
            warn.html('@MessageResource.WorkOrderCard_Display_CampaignRedServiceMustBeSelected').addClass("alert alert-danger");
        }

      

    }

</script>